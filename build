#!/usr/bin/env bash

set -e

echo "[   INFO] Build starting at $(date)"

# Always start from a clean slate
./clean

# Generate the feedChanges file using all the legacy feature folders
python generateFeedChanges.py

# Check legacy code with eslint
echo "[   INFO] Checking legacy code style with ESLint..."
yarn --silent legacy-eslint || exit

# Generate features/index.js for the new features
yarn --silent gen-featureIndex || exit

# Generate legacy and new settings
yarn --silent gen-settings || exit

# Run webpack to grab all new framework features
echo "[   INFO] Webpacking new framework..."
yarn --silent webpack || exit

# Transpile the source/ directory, putting the files in src/ which is where Kango expects to see them.
echo "[   INFO] Transpiling legacy code with Babel on ES2015 preset..."
yarn --silent legacy-babel || exit

rsync -r --ignore-existing sauce/extension/legacy* dist/toolkit

echo "[   INFO] Build finished at $(date)"
